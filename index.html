<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de Estudos Interativo - Pol√≠cia Federal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutral Harmony -->
    <!-- Application Structure Plan: A single-page application with a fixed sidebar navigation for seamless transitions between key sections: 'In√≠cio' (overview), 'Estrat√©gia CEBRASPE' (exam strategy), 'Disciplinas' (interactive subject breakdown), 'Metodologias' (study techniques), and 'Recursos' (tools and materials). The 'Disciplinas' section is the core, featuring a dynamic Chart.js visualization of topic frequencies linked to an interactive content area. This structure was chosen to transform the linear report into a non-linear, user-driven exploration tool, allowing users to quickly identify high-priority topics and drill down into details as needed, which is more efficient for study planning and review. -->
    <!-- Visualization & Content Choices:
        - Report Info: Topic frequency percentages for each subject. -> Goal: Compare topic importance. -> Viz/Method: Interactive Horizontal Bar Chart (Chart.js/Canvas). -> Interaction: Clicking a bar updates the detail view. -> Justification: Visual comparison is faster than reading lists; interaction connects overview with details.
        - Report Info: Detailed topic descriptions and practical applications. -> Goal: Inform and Organize. -> Viz/Method: Dynamic content cards/accordion (HTML/Tailwind). -> Interaction: Content appears on chart/list click. -> Justification: Reduces cognitive load by showing only relevant details on demand.
        - Report Info: CEBRASPE exam strategy ('chute direcionado'). -> Goal: Explain a process. -> Viz/Method: Step-by-step visual guide using HTML/CSS Flexbox and Unicode icons. -> Interaction: Static, clear visual flow. -> Justification: A visual process diagram is more intuitive than a block of text for procedural instructions.
        - Report Info: Study resources (courses, books). -> Goal: Organize options. -> Viz/Method: A responsive grid of styled cards (HTML/Tailwind). -> Interaction: Cards are visually distinct and can be containers for future links. -> Justification: A grid is more scannable and visually appealing than a standard list or table.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfcfb;
            color: #383838;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-height: 500px;
        }
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link.active {
            background-color: #0d9488;
            color: white;
            font-weight: 600;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .subject-button.active {
            background-color: #0f766e;
            color: white;
            border-color: #0f766e;
        }
         .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        /* Ajuste para alinhar a checkbox e o label */
        .subtopic-item {
            display: flex;
            align-items: center; /* Alinha verticalmente */
        }
        .subtopic-checkbox {
            margin-right: 0.5rem; /* Espa√ßamento entre checkbox e label */
            flex-shrink: 0; /* Impede que a checkbox encolha */
        }
        .subtopic-checkbox:checked + label {
            text-decoration: line-through;
            color: #888;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5rem;
            color: #0f766e;
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay">Carregando progresso...</div>

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-64 bg-stone-100 border-r border-stone-200 p-4 md:p-6 flex-shrink-0">
            <h1 class="text-2xl font-bold text-teal-800 mb-8">Guia PF</h1>
            <nav id="main-nav" class="space-y-2">
                <a href="#inicio" class="nav-link flex items-center p-3 rounded-lg hover:bg-stone-200">
                    <span class="mr-3 text-lg">üè†</span> In√≠cio
                </a>
                <a href="#estrategia" class="nav-link flex items-center p-3 rounded-lg hover:bg-stone-200">
                    <span class="mr-3 text-lg">üéØ</span> Estrat√©gia CEBRASPE
                </a>
                <a href="#disciplinas" class="nav-link flex items-center p-3 rounded-lg hover:bg-stone-200">
                    <span class="mr-3 text-lg">üìö</span> Disciplinas
                </a>
                <a href="#metodologias" class="nav-link flex items-center p-3 rounded-lg hover:bg-stone-200">
                    <span class="mr-3 text-lg">üí°</span> Metodologias
                </a>
                <a href="#recursos" class="nav-link flex items-center p-3 rounded-lg hover:bg-stone-200">
                    <span class="mr-3 text-lg">üõ†Ô∏è</span> Recursos
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            
            <!-- In√≠cio Section -->
            <section id="inicio" class="content-section">
                <h2 class="text-4xl font-bold text-teal-900 mb-4">Guia Estrat√©gico para o Concurso da Pol√≠cia Federal</h2>
                <p class="text-lg text-stone-600 mb-8">Uma ferramenta interativa para otimizar seus estudos e focar nos t√≥picos mais relevantes para o cargo de Agente, com base na an√°lise da banca CEBRASPE.</p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                        <h3 class="font-bold text-teal-800 text-xl mb-2">Vagas Previstas (2025)</h3>
                        <p class="text-4xl font-bold text-stone-700">1.000+</p>
                        <p class="text-sm text-stone-500">Para diversos cargos de n√≠vel superior.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                        <h3 class="font-bold text-teal-800 text-xl mb-2">Banca Examinadora</h3>
                        <p class="text-4xl font-bold text-stone-700">CEBRASPE</p>
                        <p class="text-sm text-stone-500">Formato "Certo/Errado" com penaliza√ß√£o.</p>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md border border-stone-200">
                        <h3 class="font-bold text-teal-800 text-xl mb-2">Remunera√ß√£o (Agente)</h3>
                        <p class="text-4xl font-bold text-stone-700">At√© R$26.8k</p>
                         <p class="text-sm text-stone-500">Remunera√ß√£o inicial atrativa.</p>
                    </div>
                </div>

                <div class="bg-teal-50 border-l-4 border-teal-500 p-6 rounded-lg mb-8">
                    <h3 class="font-bold text-xl text-teal-900 mb-3">Como usar este guia?</h3>
                    <p class="text-teal-800">Navegue pelas se√ß√µes ao lado para explorar as estrat√©gias de prova, mergulhar nas disciplinas com gr√°ficos interativos, conhecer metodologias de estudo eficazes e descobrir os melhores recursos para sua prepara√ß√£o. Cada se√ß√£o foi projetada para oferecer uma vis√£o clara e objetiva do caminho para a sua aprova√ß√£o.</p>
                </div>

                <!-- Overall Progress Bar -->
                <div class="mt-8">
                    <h3 class="font-bold text-xl text-teal-800 mb-2">Progresso Geral dos Estudos</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
                        <div id="overall-progress-bar" class="bg-teal-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        <span id="overall-progress-text" class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-white">0%</span>
                    </div>
                </div>
            </section>

            <!-- Estrat√©gia CEBRASPE Section -->
            <section id="estrategia" class="content-section">
                <h2 class="text-4xl font-bold text-teal-900 mb-2">Dominando a Banca CEBRASPE</h2>
                <p class="text-lg text-stone-600 mb-8">Entender a l√≥gica da banca √© o primeiro passo para a aprova√ß√£o. O formato "Certo/Errado" com penaliza√ß√£o n√£o testa apenas conhecimento, mas tamb√©m estrat√©gia e controle emocional.</p>
                
                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <h3 class="text-2xl font-bold text-center text-teal-800 mb-6">O "Chute Direcionado": Uma Estrat√©gia Inteligente</h3>
                    <p class="text-center text-stone-600 mb-8 max-w-3xl mx-auto">Para candidatos bem preparados (acima de 80% de acerto nos simulados), o chute direcionado pode aumentar a nota final. N√£o √© um chute aleat√≥rio, mas uma decis√£o baseada em an√°lise.</p>
                    
                    <div class="flex flex-col md:flex-row justify-center items-center gap-4 text-center">
                        <div class="flex-1 p-4">
                            <div class="text-5xl mb-3">1Ô∏è‚É£</div>
                            <h4 class="font-semibold text-lg text-stone-800">Resolva o que Sabe</h4>
                            <p class="text-sm text-stone-500">Primeiro, garanta os pontos das quest√µes que voc√™ tem certeza absoluta.</p>
                        </div>
                        <div class="text-2xl text-stone-300 hidden md:block">‚ûî</div>
                        <div class="flex-1 p-4">
                            <div class="text-5xl mb-3">2Ô∏è‚É£</div>
                            <h4 class="font-semibold text-lg text-stone-800">Marque a Incerteza</h4>
                            <p class="text-sm text-stone-500">Identifique as quest√µes que geram d√∫vida com um asterisco (*).</p>
                        </div>
                        <div class="text-2xl text-stone-300 hidden md:block">‚ûî</div>
                        <div class="flex-1 p-4">
                            <div class="text-5xl mb-3">3Ô∏è‚É£</div>
                            <h4 class="font-semibold text-lg text-stone-800">Contabilize</h4>
                            <p class="text-sm text-stone-500">Crie uma tabela para contar quantas marca√ß√µes 'Certo' e 'Errado' voc√™ j√° fez com certeza.</p>
                        </div>
                        <div class="text-2xl text-stone-300 hidden md:block">‚ûî</div>
                        <div class="flex-1 p-4">
                            <div class="text-5xl mb-3">4Ô∏è‚É£</div>
                            <h4 class="font-semibold text-lg text-stone-800">Equilibre e Chute</h4>
                            <p class="text-sm text-stone-500">Use a contagem para chutar nas quest√µes com *, buscando o equil√≠brio estat√≠stico da banca.</p>
                        </div>
                    </div>
                     <div class="mt-8 bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg">
                        <p class="font-semibold text-amber-900">Aten√ß√£o √†s "Pegadinhas": Palavras como <span class="font-bold">"sempre", "nunca", "exclusivamente"</span> geralmente indicam itens errados. A desconfian√ßa √© uma ferramenta de estudo!</p>
                    </div>
                </div>
            </section>
            
            <!-- Disciplinas Section -->
            <section id="disciplinas" class="content-section">
                <h2 class="text-4xl font-bold text-teal-900 mb-2">An√°lise por Disciplina</h2>
                <p class="text-lg text-stone-600 mb-8">Explore os t√≥picos mais cobrados em cada mat√©ria. Use o gr√°fico para visualizar as prioridades e clique nos itens para ver os detalhes e sua aplica√ß√£o pr√°tica no trabalho da PF.</p>
                
                <div id="subject-buttons" class="flex flex-wrap gap-3 mb-8">
                </div>

                <div class="grid lg:grid-cols-2 gap-8 items-start">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-stone-200 min-h-[500px]">
                        <h3 id="chart-title" class="text-2xl font-bold text-center text-teal-800 mb-4">T√≥picos Mais Cobrados</h3>
                        <div class="chart-container">
                            <canvas id="topicsChart"></canvas>
                        </div>
                    </div>
                    <div id="topic-details" class="space-y-4">
                        <div class="text-center p-8 text-stone-500">
                            <span class="text-4xl">‚òùÔ∏è</span>
                            <p>Selecione uma disciplina e clique em um t√≥pico no gr√°fico ou na lista para ver os detalhes.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Metodologias Section -->
            <section id="metodologias" class="content-section">
                <h2 class="text-4xl font-bold text-teal-900 mb-2">Metodologias de Estudo Eficazes</h2>
                <p class="text-lg text-stone-600 mb-8">Aprova√ß√£o n√£o √© sobre quantidade, mas sobre qualidade. Adote t√©cnicas que aceleram o aprendizado e a reten√ß√£o do conte√∫do.</p>
                <div id="methodologies-container" class="space-y-4">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-teal-500 bg-teal-50 text-teal-900">
                        <div class="flex items-start gap-4">
                            <span class="text-3xl">‚ùì</span>
                            <div>
                                <h3 class="text-xl font-bold">Estudo Ativo por Quest√µes</h3>
                                <p class="text-stone-600 mt-1">Resolver provas anteriores do CEBRASPE √© o m√©todo mais eficaz. Ajuda a entender o estilo da banca, aplicar a teoria e, principalmente, aprender com os erros. Pratique em plataformas como o <a href="https://www.qconcursos.com/questoes-de-concursos/questoes" target="_blank" class="text-teal-700 underline hover:text-teal-900">Qconcursos</a>.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-sky-500 bg-sky-50 text-sky-900">
                        <div class="flex items-start gap-4">
                            <span class="text-3xl">üß†</span>
                            <div>
                                <h3 class="text-xl font-bold">Mnem√¥nicos e Mapas Mentais</h3>
                                <p class="text-stone-600 mt-1">Crie ou use mnem√¥nicos (ex: LIMPE) e mapas visuais para memorizar regras e leis. Eles transformam informa√ß√µes densas em gatilhos de mem√≥ria r√°pidos.</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-amber-500 bg-amber-50 text-amber-900">
                        <div class="flex items-start gap-4">
                            <span class="text-3xl">üîÑ</span>
                            <div>
                                <h3 class="text-xl font-bold">Revis√£o Peri√≥dica</h3>
                                <p class="text-stone-600 mt-1">O c√©rebro esquece. Crie um ciclo de revis√µes (24h, 7 dias, 30 dias) para transferir o conhecimento da mem√≥ria de curto prazo para a de longo prazo. Revisar √© t√£o importante quanto aprender.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recursos Section -->
            <section id="recursos" class="content-section">
                <h2 class="text-4xl font-bold text-teal-900 mb-2">Recursos Essenciais para Aprova√ß√£o</h2>
                <p class="text-lg text-stone-600 mb-8">Uma sele√ß√£o de ferramentas e materiais que podem fazer a diferen√ßa na sua prepara√ß√£o.</p>
                <div id="resources-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Resources will be dynamically inserted here -->
                </div>
            </section>

        </main>
    </div>

<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Firebase instances and user ID
    let app, db, auth, userId;
    let isAuthReady = false;

    // Firebase configuration provided by the user
    const firebaseConfig = {
      apiKey: "AIzaSyCm9-J3pJOZHyYkSouKqXJ7AjU_KTS_Lj8",
      authDomain: "guiaestudospf.firebaseapp.com",
      projectId: "guiaestudospf",
      storageBucket: "guiaestudospf.firebasestorage.app",
      messagingSenderId: "25016477305",
      appId: "1:25016477305:web:29569181e14d0bb2df56a8"
    };
    // Using projectId for appId for consistency with Firestore document paths
    const appId = firebaseConfig.projectId;
    const initialAuthToken = null; // Mantenha como null para autentica√ß√£o an√¥nima

    // Default study data (initial state if no saved data is found)
    let studyData = {
        subjects: {
            portugues: {
                name: "L√≠ngua Portuguesa",
                icon: "üìò",
                chartData: {
                    labels: ['Interpreta√ß√£o Textual', 'Gram√°tica Sint√°tica', 'Ortografia e Sem√¢ntica', 'Concord√¢ncia e Reg√™ncia', 'Reescrita e Pronomes'],
                    data: [30, 20, 15, 15, 20],
                },
                topics: [
                    { title: "Interpreta√ß√£o Textual", detail: "Principal foco da prova. Avalia a capacidade de extrair informa√ß√µes expl√≠citas e impl√≠citas, identificar a finalidade do texto e as rela√ß√µes l√≥gico-discursivas.", application: "Habilidade crucial para analisar depoimentos, relat√≥rios de intelig√™ncia e documentos em investiga√ß√µes, garantindo a compreens√£o correta dos fatos.",
                      subtopics: [
                          { name: "Compreens√£o e Interpreta√ß√£o de Textos", completed: false },
                          { name: "Tipos e G√™neros Textuais", completed: false }
                      ]
                    },
                    { title: "Ortografia, Acentua√ß√£o Gr√°fica e Crase", detail: "Dominar as regras de acentua√ß√£o, uso do h√≠fen e grafia correta, al√©m do uso da crase, √© a base para a clareza e formalidade na escrita.", application: "A base da formalidade e clareza na escrita de documentos oficiais, evitando ambiguidades e erros gramaticais.",
                      subtopics: [
                          { name: "Ortografia", completed: false },
                          { name: "Acentua√ß√£o Gr√°fica", completed: false },
                          { name: "Crase", completed: false }
                      ]
                    },
                    { title: "Classes de Palavras e Estrutura", detail: "Ser capaz de identificar e classificar corretamente cada palavra e entender sua fun√ß√£o no per√≠odo √© o alicerce para toda a an√°lise sint√°tica.", application: "Permite a an√°lise precisa da estrutura de documentos e comunica√ß√µes, garantindo a correta interpreta√ß√£o legal e oficial.",
                      subtopics: [
                          { name: "Classes de Palavras", completed: false },
                          { name: "Forma√ß√£o e Estrutura das Palavras", completed: false }
                      ]
                    },
                    { title: "Termos da Ora√ß√£o e An√°lise Sint√°tica", detail: "Compreender a fun√ß√£o de cada termo na ora√ß√£o, incluindo as particularidades de 'se', 'que' e 'como', √© essencial para a constru√ß√£o e an√°lise de frases complexas.", application: "Fundamental para a constru√ß√£o de frases com clareza e precis√£o em relat√≥rios e inqu√©ritos, evitando interpreta√ß√µes equivocadas.",
                      subtopics: [
                          { name: "Termos da Ora√ß√£o", completed: false },
                          { name: "Part√≠cula 'se'", completed: false },
                          { name: "Voc√°bulo 'que'", completed: false },
                          { name: "Voc√°bulo 'como'", completed: false }
                      ]
                    },
                    { title: "Concord√¢ncia e Vozes Verbais", detail: "Entender as regras que regem a rela√ß√£o de n√∫mero e g√™nero entre os termos, al√©m das vozes verbais, √© crucial para evitar erros gramaticais b√°sicos e garantir a corre√ß√£o do texto.", application: "Garante a corre√ß√£o gramatical e a formalidade na comunica√ß√£o oficial, transmitindo profissionalismo e credibilidade, especialmente em depoimentos.",
                      subtopics: [
                          { name: "Concord√¢ncia Verbal", completed: false },
                          { name: "Concord√¢ncia Nominal", completed: false },
                          { name: "Vozes Verbais", completed: false }
                      ]
                    },
                    { title: "Sem√¢ntica e Reg√™ncia", detail: "Dominar o significado das palavras, a rela√ß√£o de depend√™ncia entre verbos/nomes e seus complementos √© vital para a precis√£o e clareza textual.", application: "Essencial para a precis√£o da linguagem em pe√ßas jur√≠dicas e relat√≥rios, evitando ambiguidades e garantindo a correta interpreta√ß√£o dos fatos.",
                      subtopics: [
                          { name: "Sem√¢ntica", completed: false },
                          { name: "Reg√™ncia Verbal", completed: false },
                          { name: "Reg√™ncia Nominal", completed: false }
                      ]
                    },
                    { title: "Fun√ß√£o Sint√°tica e Coloca√ß√£o Pronominal", detail: "Conhecer a fun√ß√£o sint√°tica dos pronomes e as regras de coloca√ß√£o pronominal garante a corre√ß√£o gramatical e a fluidez do texto.", application: "Permite a escrita de documentos e comunica√ß√µes oficiais com total corre√ß√£o gramatical e fluidez, essencial para a credibilidade.",
                      subtopics: [
                          { name: "Fun√ß√£o Sint√°tica dos Pronomes √Åtonos", completed: false },
                          { name: "Fun√ß√£o Sint√°tica dos Pronomes Relativos", completed: false },
                          { name: "Coloca√ß√£o Pronominal", completed: false }
                      ]
                    },
                    { title: "Coes√£o Textual", detail: "Elementos de referencia√ß√£o, substitui√ß√£o, repeti√ß√£o, conectores e sequencia√ß√£o textual, e tempos e modos verbais.", application: "A compreens√£o da coes√£o √© a ponte para a an√°lise da estrutura sint√°tica, crucial para a reda√ß√£o de documentos formais.",
                      subtopics: [
                          { name: "Elementos de Referencia√ß√£o, Substitui√ß√£o e Repeti√ß√£o", completed: false },
                          { name: "Conectores e Sequencia√ß√£o Textual", completed: false },
                          { name: "Tempos e Modos Verbais", completed: false }
                      ]
                    },
                    { title: "Reescrita de Textos", detail: "Significa√ß√£o de palavras, substitui√ß√µes, reorganiza√ß√£o estrutural e adequa√ß√£o de g√™nero e formalidade.", application: "A reescrita √© a aplica√ß√£o pr√°tica de todas as suas habilidades em interpreta√ß√£o e gram√°tica, fundamental para adaptar e resumir informa√ß√µes.",
                      subtopics: [
                          { name: "Significa√ß√£o de Palavras", completed: false },
                          { name: "Substitui√ß√µes", completed: false },
                          { name: "Reorganiza√ß√£o Estrutural", completed: false },
                          { name: "Adequa√ß√£o de G√™nero e Formalidade", completed: false }
                      ]
                    },
                    { title: "Correspond√™ncia Oficial (Manual da PR)", detail: "Aspectos gerais, finalidade, linguagem apropriada e formata√ß√£o textual da comunica√ß√£o oficial.", application: "Uma aplica√ß√£o espec√≠fica das regras de portugu√™s em um contexto formal e profissional, vital para a PF.",
                      subtopics: [
                          { name: "Aspectos Gerais", completed: false },
                          { name: "Finalidade", completed: false },
                          { name: "Linguagem Apropriada", completed: false },
                          { name: "Formata√ß√£o Textual", completed: false }
                      ]
                    }
                ]
            },
            raciocinio: {
                name: "Racioc√≠nio L√≥gico",
                icon: "üî¢",
                chartData: {
                    labels: ['L√≥gica Sentencial', 'L√≥gica de Argumenta√ß√£o', 'An√°lise Combinat√≥ria', 'Probabilidade', 'Racioc√≠nio Aritm√©tico'],
                    data: [25, 25, 15, 15, 20],
                },
                topics: [
                    { title: "L√≥gica Sentencial (ou Proposicional)", detail: "Entender o conceito de proposi√ß√£o, os conectivos l√≥gicos, tabelas-verdade, equival√™ncias e nega√ß√µes √© o alicerce para a an√°lise de argumentos complexos.", application: "Base para a an√°lise de evid√™ncias e constru√ß√£o de linhas de investiga√ß√£o coerentes, avaliando a veracidade de declara√ß√µes e fatos.",
                      subtopics: [
                          { name: "Estruturas L√≥gicas", completed: false },
                          { name: "Proposi√ß√µes (Simples e Compostas)", completed: false },
                          { name: "Conectivos L√≥gicos (e, ou, se... ent√£o, se e somente se, n√£o)", completed: false },
                          { name: "Tabelas Verdade", completed: false },
                          { name: "Leis de De Morgan", completed: false },
                          { name: "Equival√™ncias L√≥gicas", completed: false },
                          { name: "Nega√ß√£o de Proposi√ß√µes", completed: false }
                      ]
                    },
                    { title: "L√≥gica de Argumenta√ß√£o e Conjuntos", detail: "Habilidade de identificar premissas e conclus√£o em um argumento, analisar sua validade, usar diagramas l√≥gicos e opera√ß√µes com conjuntos para resolver problemas.", application: "Ajuda a identificar contradi√ß√µes e inconsist√™ncias em depoimentos ou √°libis, confrontando diferentes vers√µes de um mesmo fato, e organizar informa√ß√µes.",
                      subtopics: [
                          { name: "L√≥gica de Argumenta√ß√£o", completed: false },
                          { name: "Diagramas L√≥gicos", completed: false },
                          { name: "Associa√ß√£o de Informa√ß√µes", completed: false },
                          { name: "Argumentos (An√°lise de Validade)", completed: false },
                          { name: "Opera√ß√µes c/ Conjuntos", completed: false }
                      ]
                    },
                    { title: "Princ√≠pios de Contagem (An√°lise Combinat√≥ria)", detail: "Compreender os Princ√≠pios Multiplicativo e Aditivo, e saber diferenciar e aplicar Permuta√ß√µes, Combina√ß√µes e Arranjos para contar possibilidades.", application: "√ötil em investiga√ß√µes que envolvem a an√°lise de um grande n√∫mero de possibilidades, como quebra de senhas, cruzamento de dados ou padr√µes criminais.",
                      subtopics: [
                          { name: "Princ√≠pios de Contagem (An√°lise Combinat√≥ria)", completed: false }
                      ]
                    },
                    { title: "Probabilidade", detail: "Entender o conceito de experimento aleat√≥rio, espa√ßo amostral e evento, e saber calcular a probabilidade de eventos simples e compostos, incluindo probabilidade condicional.", application: "Aplicada na avalia√ß√£o da for√ßa de uma evid√™ncia e na an√°lise de risco para prever a ocorr√™ncia de crimes com base em padr√µes estat√≠sticos.",
                      subtopics: [
                          { name: "Probabilidade", completed: false }
                      ]
                    },
                    { title: "Racioc√≠nio L√≥gico-Aritm√©tico", detail: "Problemas que envolvem opera√ß√µes com n√∫meros reais, MMC, MDC, raz√£o, propor√ß√£o, regra de tr√™s, equa√ß√µes e unidades de medidas.", application: "Essencial para a an√°lise de dados quantitativos em investiga√ß√µes financeiras, per√≠cias e para compreender escalas e convers√µes.",
                      subtopics: [
                          { name: "Unidades de Medidas", completed: false },
                          { name: "Opera√ß√µes c/ N√∫meros Reais", completed: false },
                          { name: "MMC e MDC", completed: false },
                          { name: "Raz√£o", completed: false },
                          { name: "Propor√ß√£o e Regra de Tr√™s", completed: false },
                          { name: "Equa√ß√µes", completed: false }
                      ]
                    }
                ]
            },
            contabilidade: {
                name: "Contabilidade Geral",
                icon: "üìí",
                chartData: {
                    labels: ['Conceitos e Patrim√¥nio', 'Atos e Fatos', 'Contas e Escritura√ß√£o', 'Demonstra√ß√µes', 'Legisla√ß√£o Cont√°bil'],
                    data: [15, 10, 25, 30, 20],
                },
                topics: [
                    { title: "Conceitos e Patrim√¥nio", detail: "A base da contabilidade, compreendendo o que √© patrim√¥nio, seus componentes (bens, direitos e obriga√ß√µes) e a equa√ß√£o fundamental.", application: "A funda√ß√£o para qualquer an√°lise financeira, crucial para o rastreamento de bens e a compreens√£o da estrutura patrimonial em investiga√ß√µes de lavagem de dinheiro.",
                      subtopics: [
                          { name: "Conceitos, objetivos e finalidades da contabilidade", completed: false },
                          { name: "Patrim√¥nio: componentes", completed: false },
                          { name: "Equa√ß√£o fundamental do patrim√¥nio", completed: false },
                          { name: "Situa√ß√£o l√≠quida", completed: false },
                          { name: "Representa√ß√£o gr√°fica do patrim√¥nio", completed: false }
                      ]
                    },
                    { title: "Atos e Fatos Administrativos", detail: "Diferencia√ß√£o entre atos que n√£o alteram o patrim√¥nio e fatos cont√°beis (permutativos, modificativos e mistos) que geram registros.", application: "Essencial para identificar a origem e o impacto das opera√ß√µes financeiras, fundamental para reconstruir o fluxo de recursos em investiga√ß√µes.",
                      subtopics: [
                          { name: "Atos e fatos administrativos: conceitos", completed: false },
                          { name: "Fatos permutativos", completed: false },
                          { name: "Fatos modificativos", completed: false },
                          { name: "Fatos mistos", completed: false }
                      ]
                    },
                    { title: "Contas e Escritura√ß√£o", detail: "Conceitos de contas (d√©bitos, cr√©ditos, saldos), plano de contas, e os m√©todos e livros de escritura√ß√£o (lan√ßamentos, regime de compet√™ncia e caixa).", application: "Fundamental para verificar a regularidade dos registros e identificar lan√ßamentos falsos ou suspeitos que sirvam como prova material de um crime financeiro.",
                      subtopics: [
                          { name: "Contas: conceitos, contas de d√©bitos, contas de cr√©ditos e saldos", completed: false },
                          { name: "Plano de contas: conceitos, elenco de contas, fun√ß√£o e funcionamento das contas", completed: false },
                          { name: "Escritura√ß√£o: conceitos", completed: false },
                          { name: "Lan√ßamentos cont√°beis, elementos essenciais, f√≥rmulas de lan√ßamentos", completed: false },
                          { name: "M√©todos e processos de escritura√ß√£o", completed: false },
                          { name: "Livros de escritura√ß√£o", completed: false },
                          { name: "Regime de compet√™ncia e regime de caixa", completed: false },
                          { name: "Contabiliza√ß√£o de opera√ß√µes cont√°beis diversas: deprecia√ß√µes e baixa de bens", completed: false },
                          { name: "Contabiliza√ß√£o de opera√ß√µes cont√°beis diversas: folha de pagamento", completed: false }
                      ]
                    },
                    { title: "Demonstra√ß√µes Cont√°beis", detail: "Estudo aprofundado do Balan√ßo Patrimonial (Ativo Circulante, N√£o Circulante, Imobilizado, Passivo, Patrim√¥nio L√≠quido) e da Demonstra√ß√£o de Resultado do Exerc√≠cio (DRE).", application: "Essencial para identificar fraudes, desvios e lavagem de dinheiro, pois as demonstra√ß√µes s√£o o 'raio-x' da sa√∫de financeira de uma empresa investigada.",
                      subtopics: [
                          { name: "Balancete de verifica√ß√£o: conceitos, modelos e t√©cnicas de elabora√ß√£o", completed: false },
                          { name: "Balan√ßo patrimonial: conceitos, objetivo, composi√ß√£o", completed: false },
                          { name: "Ativo Circulante e Ativo N√£o Circulante", completed: false },
                          { name: "Ativo Imobilizado", completed: false },
                          { name: "Passivo", completed: false },
                          { name: "Patrim√¥nio L√≠quido", completed: false },
                          { name: "Demonstra√ß√£o de Resultado do Exerc√≠cio: conceito, objetivo, composi√ß√£o", completed: false }
                      ]
                    },
                    { title: "Legisla√ß√£o Cont√°bil", detail: "An√°lise da Lei n¬∫ 6.404/1976 e suas altera√ß√µes, legisla√ß√£o complementar, pronunciamentos do CPC (ex: CPC 01, CPC 04, CPC 25) e Notas Explicativas.", application: "Crucial para aplicar as normas cont√°beis em per√≠cias e investiga√ß√µes, garantindo a conformidade legal e a validade das provas.",
                      subtopics: [
                          { name: "Lei n¬∫ 6.404/1976 e suas altera√ß√µes", completed: false },
                          { name: "Legisla√ß√£o complementar", completed: false },
                          { name: "Pronunciamentos do Comit√™ de Pronunciamentos Cont√°beis (CPC)", completed: false },
                          { name: "Notas Explicativas", completed: false },
                          { name: "CPC 01 (R1) - Redu√ß√£o ao Valor Recuper√°vel de Ativos", completed: false },
                          { name: "CPC 04 (R1) - Ativo Intang√≠vel", completed: false },
                          { name: "CPC 25 - Provis√µes, Passivos Contingentes e Ativos Contingentes", completed: false }
                      ]
                    }
                ]
            },
            informatica: {
                name: "Inform√°tica",
                icon: "üñ•Ô∏è",
                chartData: {
                    labels: ['Redes e Protocolos', 'Seguran√ßa da Informa√ß√£o', 'Banco de Dados', 'Programa√ß√£o e BI', 'Computa√ß√£o na Nuvem', 'Ferramentas e Apps'],
                    data: [25, 20, 18, 15, 12, 10],
                },
                topics: [
                    { title: "Redes e Protocolos", detail: "Conceitos de redes (LAN, MAN, WAN, sem fio), arquitetura (OSI/TCP-IP), endere√ßamento (IPv4/IPv6) e funcionamento dos principais protocolos (HTTP, FTP, SMTP, DNS, SSL/TLS).", application: "Indispens√°vel para rastrear a origem de ataques cibern√©ticos, analisar o tr√°fego de rede de suspeitos e entender como a comunica√ß√£o ocorre na internet.",
                      subtopics: [
                          { name: "Redes de comunica√ß√£o: Introdu√ß√£o a redes (computa√ß√£o/telecomunica√ß√µes)", completed: false },
                          { name: "No√ß√µes b√°sicas de transmiss√£o de dados: tipos de enlace, c√≥digos, modos e meios de transmiss√£o", completed: false },
                          { name: "Redes de computadores: locais, metropolitanas e de longa dist√¢ncia", completed: false },
                          { name: "No√ß√µes de arquitetura e princ√≠pios de funcionamento das redes", completed: false },
                          { name: "Tipos de redes: locais (LAN), metropolitanas (MAN) e de longa dist√¢ncia (WAN)", completed: false },
                          { name: "Redes sem fio: padr√µes IEEE 802.11, WPA/WPA2, seguran√ßa e boas pr√°ticas", completed: false },
                          { name: "Terminologia e aplica√ß√µes, topologias, modelos de arquitetura (OSI/ISO e TCP/IP) e protocolos", completed: false },
                          { name: "Interconex√£o de redes, n√≠vel de transporte", completed: false },
                          { name: "Forma√ß√£o de endere√ßos IPV4 e IPV6", completed: false },
                          { name: "Modelo OSI/ISO e modelo TCP/IP: camadas, fun√ß√µes e protocolos associados", completed: false },
                          { name: "Protocolos de comunica√ß√£o: Ethernet, TCP, UDP, DNS, DHCP e SNMP", completed: false },
                          { name: "SSL/TLS", completed: false },
                          { name: "Camada f√≠sica, de enlace de dados e subcamada de acesso ao meio", completed: false },
                          { name: "Conceito de internet e intranet", completed: false },
                          { name: "Protocolos e mecanismos de seguran√ßa: VPN", completed: false }
                      ]
                    },
                    { title: "Seguran√ßa da Informa√ß√£o", detail: "No√ß√µes de criptografia (hash, assinaturas digitais), autentica√ß√£o (MFA), controle de acesso, amea√ßas (malware, phishing, ransomware) e testes de acur√°cia (NIST.GOV, FPIR, FNIR).", application: "√â a base do combate ao cibercrime e da prote√ß√£o de dados sigilosos da pr√≥pria investiga√ß√£o, garantindo a integridade das evid√™ncias digitais.",
                      subtopics: [
                          { name: "Conceitos de prote√ß√£o e seguran√ßa", completed: false },
                          { name: "No√ß√µes de criptografia e prote√ß√£o de dados: hash criptogr√°fico (MD5, SHA-1, SHA-256)", completed: false },
                          { name: "Assinaturas digitais", completed: false },
                          { name: "Autentica√ß√£o multifator (MFA)", completed: false },
                          { name: "No√ß√µes de Controle de acesso e autentica√ß√£o", completed: false },
                          { name: "Testes de acur√°cia do NIST.GOV", completed: false },
                          { name: "Conceitos de falso positivo e falso negativo (FPIR e FNIR)", completed: false }
                      ]
                    },
                    { title: "Banco de Dados", detail: "Modelagem conceitual (entidade-relacionamento), bancos de dados relacionais (chaves, relacionamentos) e no√ß√µes de linguagem SQL.", application: "Essencial para analisar grandes volumes de dados de quebras de sigilo (telef√¥nico, banc√°rio), identificar conex√µes e encontrar a 'agulha no palheiro'.",
                      subtopics: [
                          { name: "Modelagem conceitual: abstra√ß√£o, modelo entidade-relacionamento, an√°lise funcional e administra√ß√£o de dados", completed: false },
                          { name: "Entidades, atributos e relacionamentos", completed: false },
                          { name: "Banco de dados relacionais: conceitos b√°sicos e caracter√≠sticas", completed: false },
                          { name: "Chaves e relacionamentos", completed: false },
                          { name: "No√ß√µes de linguagem SQL", completed: false }
                      ]
                    },
                    { title: "Programa√ß√£o e Business Intelligence", detail: "No√ß√µes de programa√ß√£o (Python, R), conceito de API, e Business Intelligence (ferramentas, ETL/ELT, Data Warehouse, Data Mart, Data Lake, Data Mesh).", application: "Permite a an√°lise de c√≥digos maliciosos, o desenvolvimento de ferramentas para investiga√ß√µes e a automa√ß√£o da an√°lise de grandes volumes de dados.",
                      subtopics: [
                          { name: "No√ß√µes de Business Intelligence: Ferramentas e aplicabilidade", completed: false },
                          { name: "ETL/ELT (Extract, Transform, Load)", completed: false },
                          { name: "Conceito de DataWarehouse", completed: false },
                          { name: "Conceito de DataMart", completed: false },
                          { name: "Conceito de DataLake", completed: false },
                          { name: "Conceito de DataMesh", completed: false },
                          { name: "No√ß√µes de Programa√ß√£o e Interoperabilidade", completed: false },
                          { name: "No√ß√µes de programa√ß√£o em Python", completed: false },
                          { name: "Conceito de API (Application Programming Interface)", completed: false },
                          { name: "No√ß√µes de programa√ß√£o R", completed: false }
                      ]
                    },
                    { title: "Computa√ß√£o na Nuvem", detail: "Defini√ß√£o e caracter√≠sticas das nuvens (privadas e p√∫blicas) e modelos de servi√ßo (IaaS, PaaS, SaaS).", application: "Relevante pois muitos criminosos usam servi√ßos em nuvem para armazenar dados e coordenar atividades il√≠citas, exigindo conhecimento para per√≠cia nesse ambiente.",
                      subtopics: [
                          { name: "No√ß√µes de Computa√ß√£o em Nuvem", completed: false },
                          { name: "Defini√ß√£o e caracter√≠sticas das nuvens privadas e p√∫blicas", completed: false },
                          { name: "Modelos de Servi√ßo em Nuvem: Infraestrutura como Servi√ßo (IaaS), Plataforma como Servi√ßo (PaaS) e Software como Servi√ßo (SaaS)", completed: false }
                      ]
                    },
                    { title: "Ferramentas e Aplicativos", detail: "Ferramentas comerciais de navega√ß√£o, correio eletr√¥nico, grupos de discuss√£o, busca e pesquisa, √°udio/v√≠deo/multim√≠dia, acesso √† dist√¢ncia e transfer√™ncia de arquivos.", application: "Conhecimento operacional de ferramentas digitais para coleta, an√°lise e gerenciamento de informa√ß√µes durante investiga√ß√µes.",
                      subtopics: [
                          { name: "Ferramentas e aplicativos comerciais de navega√ß√£o", completed: false },
                          { name: "Ferramentas e aplicativos comerciais de Correio eletr√¥nico", completed: false },
                          { name: "Grupos de discuss√£o", completed: false },
                          { name: "Ferramentas e aplicativos comerciais de busca e pesquisa", completed: false },
                          { name: "Aplicativos de √°udio, v√≠deo e multim√≠dia", completed: false },
                          { name: "Acesso √† dist√¢ncia a computadores, transfer√™ncia de informa√ß√£o e arquivos", completed: false }
                      ]
                    }
                ]
            },
            raciocinio: {
                name: "Racioc√≠nio L√≥gico",
                icon: "üî¢",
                chartData: {
                    labels: ['L√≥gica Sentencial', 'L√≥gica de Argumenta√ß√£o', 'An√°lise Combinat√≥ria', 'Probabilidade', 'Racioc√≠nio Aritm√©tico'],
                    data: [25, 25, 15, 15, 20],
                },
                topics: [
                    { title: "L√≥gica Sentencial (ou Proposicional)", detail: "Entender o conceito de proposi√ß√£o, os conectivos l√≥gicos, tabelas-verdade, equival√™ncias e nega√ß√µes √© o alicerce para a an√°lise de argumentos complexos.", application: "Base para a an√°lise de evid√™ncias e constru√ß√£o de linhas de investiga√ß√£o coerentes, avaliando a veracidade de declara√ß√µes e fatos.",
                      subtopics: [
                          { name: "Estruturas L√≥gicas", completed: false },
                          { name: "Proposi√ß√µes (Simples e Compostas)", completed: false },
                          { name: "Conectivos L√≥gicos (e, ou, se... ent√£o, se e somente se, n√£o)", completed: false },
                          { name: "Tabelas Verdade", completed: false },
                          { name: "Leis de De Morgan", completed: false },
                          { name: "Equival√™ncias L√≥gicas", completed: false },
                          { name: "Nega√ß√£o de Proposi√ß√µes", completed: false }
                      ]
                    },
                    { title: "L√≥gica de Argumenta√ß√£o e Conjuntos", detail: "Habilidade de identificar premissas e conclus√£o em um argumento, analisar sua validade, usar diagramas l√≥gicos e opera√ß√µes com conjuntos para resolver problemas.", application: "Ajuda a identificar contradi√ß√µes e inconsist√™ncias em depoimentos ou √°libis, confrontando diferentes vers√µes de um mesmo fato, e organizar informa√ß√µes.",
                      subtopics: [
                          { name: "L√≥gica de Argumenta√ß√£o", completed: false },
                          { name: "Diagramas L√≥gicos", completed: false },
                          { name: "Associa√ß√£o de Informa√ß√µes", completed: false },
                          { name: "Argumentos (An√°lise de Validade)", completed: false },
                          { name: "Opera√ß√µes c/ Conjuntos", completed: false }
                      ]
                    },
                    { title: "Princ√≠pios de Contagem (An√°lise Combinat√≥ria)", detail: "Compreender os Princ√≠pios Multiplicativo e Aditivo, e saber diferenciar e aplicar Permuta√ß√µes, Combina√ß√µes e Arranjos para contar possibilidades.", application: "√ötil em investiga√ß√µes que envolvem a an√°lise de um grande n√∫mero de possibilidades, como quebra de senhas, cruzamento de dados ou padr√µes criminais.",
                      subtopics: [
                          { name: "Princ√≠pios de Contagem (An√°lise Combinat√≥ria)", completed: false }
                      ]
                    },
                    { title: "Probabilidade", detail: "Entender o conceito de experimento aleat√≥rio, espa√ßo amostral e evento, e saber calcular a probabilidade de eventos simples e compostos, incluindo probabilidade condicional.", application: "Aplicada na avalia√ß√£o da for√ßa de uma evid√™ncia e na an√°lise de risco para prever a ocorr√™ncia de crimes com base em padr√µes estat√≠sticos.",
                      subtopics: [
                          { name: "Probabilidade", completed: false }
                      ]
                    },
                    { title: "Racioc√≠nio L√≥gico-Aritm√©tico", detail: "Problemas que envolvem opera√ß√µes com n√∫meros reais, MMC, MDC, raz√£o, propor√ß√£o, regra de tr√™s, equa√ß√µes e unidades de medidas.", application: "Essencial para a an√°lise de dados quantitativos em investiga√ß√µes financeiras, per√≠cias e para compreender escalas e convers√µes.",
                      subtopics: [
                          { name: "Unidades de Medidas", completed: false },
                          { name: "Opera√ß√µes c/ N√∫meros Reais", completed: false },
                          { name: "MMC e MDC", completed: false },
                          { name: "Raz√£o", completed: false },
                          { name: "Propor√ß√£o e Regra de Tr√™s", completed: false },
                          { name: "Equa√ß√µes", completed: false }
                      ]
                    }
                ]
            }
        },
        methodologies: [
            {
                icon: '‚ùì',
                title: 'Estudo Ativo por Quest√µes',
                description: 'Resolver provas anteriores do CEBRASPE √© o m√©todo mais eficaz. Ajuda a entender o estilo da banca, aplicar a teoria e, principalmente, aprender com os erros. Pratique em plataformas como o <a href="https://www.qconcursos.com/questoes-de-concursos/questoes" target="_blank" class="text-teal-700 underline hover:text-teal-900">Qconcursos</a>.',
                color: 'teal'
            },
            {
                icon: 'üß†',
                title: 'Mnem√¥nicos e Mapas Mentais',
                description: 'Crie ou use mnem√¥nicos (ex: LIMPE) e mapas visuais para memorizar regras e leis. Eles transformam informa√ß√µes densas em gatilhos de mem√≥ria r√°pidos.',
                color: 'sky'
            },
            {
                icon: 'üîÑ',
                title: 'Revis√£o Peri√≥dica',
                description: 'O c√©rebro esquece. Crie um ciclo de revis√µes (24h, 7 dias, 30 dias) para transferir o conhecimento da mem√≥ria de curto prazo para a de longo prazo. Revisar √© t√£o importante quanto aprender.',
                color: 'amber'
            }
        ],
        resources: [
            {
                icon: 'üíª',
                title: 'Plataformas de Quest√µes',
                items: ['Qconcursos', 'Tecconcursos'],
                description: 'Essenciais para a pr√°tica massiva e filtragem por banca, assunto e ano.',
                color: 'indigo'
            },
            {
                icon: 'üéì',
                title: 'Cursos Preparat√≥rios',
                items: ['Gran Cursos Online', 'Estrat√©gia Concursos'],
                description: 'Oferecem material direcionado, videoaulas e PDFs focados no edital da PF.',
                color: 'rose'
            },
            {
                icon: 'üìñ',
                title: 'Livros Especializados',
                items: ['Editora Juspodivm'],
                description: 'Fornecem aprofundamento te√≥rico em disciplinas-chave com autores renomeados.',
                color: 'emerald'
            },
             {
                icon: 'üó∫Ô∏è',
                title: 'Mapas Mentais',
                items: ['Mapas da Lulu'],
                description: 'Recurso visual para revis√µes r√°pidas e consolida√ß√£o do conte√∫do.',
                color: 'violet'
            },
        ]
    };

    let currentChart = null;

    // Function to save progress to Firestore
    async function saveProgress() {
        if (!db || !userId) {
            console.error("Firestore ou User ID n√£o inicializados. N√£o foi poss√≠vel salvar.");
            return;
        }
        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/pf_study_data/progress`);
            // Convertendo para JSON string para evitar problemas de serializa√ß√£o do Firestore com objetos aninhados profundos
            await setDoc(userDocRef, { subjects: JSON.stringify(studyData.subjects) });
            console.log("Progresso salvo com sucesso!");
        } catch (e) {
            console.error("Erro ao salvar progresso: ", e);
        }
    }

    // Function to load progress from Firestore
    async function loadProgress() {
        return new Promise(resolve => {
            if (!db || !userId) {
                console.warn("Firestore ou User ID n√£o inicializados. Tentando novamente em breve.");
                resolve();
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/pf_study_data/progress`);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    if (loadedData && loadedData.subjects) {
                        try {
                            const loadedSubjects = JSON.parse(loadedData.subjects); // Parse back from JSON string
                            // Deep merge the loaded data with the default studyData
                            for (const subjectKey in studyData.subjects) {
                                if (loadedSubjects[subjectKey]) {
                                    studyData.subjects[subjectKey].topics.forEach((topic, topicIndex) => {
                                        if (loadedSubjects[subjectKey].topics[topicIndex]) {
                                            topic.subtopics.forEach((subtopic, subtopicIndex) => {
                                                if (loadedSubjects[subjectKey].topics[topicIndex].subtopics[subtopicIndex] !== undefined) {
                                                    subtopic.completed = loadedSubjects[subjectKey].topics[topicIndex].subtopics[subtopicIndex].completed;
                                                }
                                            });
                                        }
                                    });
                                }
                            });
                            console.log("Progresso carregado com sucesso!");
                        } catch (parseError) {
                            console.error("Erro ao fazer parse do progresso salvo: ", parseError);
                        }
                    }
                } else {
                    console.log("Nenhum progresso salvo encontrado. Iniciando com dados padr√£o.");
                    saveProgress(); // Save initial data if no progress exists
                }
                updateProgressBar(); // Ensure progress bar is updated after load
                resolve();
            }, (error) => {
                console.error("Erro ao carregar progresso: ", error);
                resolve(); // Resolve even on error to unblock UI
            });
        });
    }

    function getTotalSubtopics() {
        let total = 0;
        for (const subjectKey in studyData.subjects) {
            studyData.subjects[subjectKey].topics.forEach(topic => {
                if (topic.subtopics) {
                    total += topic.subtopics.length;
                }
            });
        }
        return total;
    }

    function getCompletedSubtopics() {
        let completed = 0;
        for (const subjectKey in studyData.subjects) {
            studyData.subjects[subjectKey].topics.forEach(topic => {
                if (topic.subtopics) {
                    topic.subtopics.forEach(subtopic => {
                        if (subtopic.completed) {
                            completed++;
                        }
                    });
                }
            });
        }
        return completed;
    }

    function updateProgressBar() {
        const total = getTotalSubtopics();
        const completed = getCompletedSubtopics();
        const percentage = total === 0 ? 0 : Math.round((completed / total) * 100);

        const progressBar = document.getElementById('overall-progress-bar');
        const progressText = document.getElementById('overall-progress-text');

        if (progressBar && progressText) {
            progressBar.style.width = `${percentage}%`;
            progressText.innerText = `${percentage}%`;
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.style.display = 'flex'; // Show loading overlay

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authenticate user
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // Set userId after authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    await loadProgress(); // Load data once authentication is ready
                    
                    // Initial rendering after data is loaded
                    const initialHash = window.location.hash || '#inicio';
                    navigateTo(initialHash);
                    populateResources();
                    const firstSubjectKey = Object.keys(studyData.subjects)[0];
                    if (document.querySelector(`.subject-button[data-subject="${firstSubjectKey}"]`)) {
                        document.querySelector(`.subject-button[data-subject="${firstSubjectKey}"]`).click();
                    }
                    loadingOverlay.style.display = 'none'; // Hide loading overlay
                } else {
                    // Fallback if authentication fails
                    userId = crypto.randomUUID(); // Use a random ID for unauthenticated users
                    isAuthReady = true;
                    console.warn("Usu√°rio n√£o autenticado, usando ID an√¥nimo. Progresso n√£o ser√° persistente em diferentes sess√µes/dispositivos.");
                    loadingOverlay.style.display = 'none'; // Hide loading overlay even if not persisted
                }
            });

        } catch (e) {
            console.error("Erro na inicializa√ß√£o do Firebase ou autentica√ß√£o: ", e);
            loadingOverlay.style.display = 'none'; // Hide loading overlay on error
            // Using a simple message box instead of alert() for better UX
            const errorMessage = document.createElement('div');
            errorMessage.textContent = "Erro ao carregar o aplicativo. Verifique sua conex√£o ou tente novamente.";
            errorMessage.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(255,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:1001;";
            document.body.appendChild(errorMessage);
            setTimeout(() => errorMessage.remove(), 5000); // Remove message after 5 seconds
        }


        const navLinks = document.querySelectorAll('#main-nav a');
        const contentSections = document.querySelectorAll('.content-section');
        const subjectButtonsContainer = document.getElementById('subject-buttons');
        const topicDetailsContainer = document.getElementById('topic-details');
        
        function navigateTo(hash) {
            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === hash);
            });
            contentSections.forEach(section => {
                section.classList.toggle('active', `#${section.id}` === hash);
            });
        }
        
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = link.getAttribute('href');
                navigateTo(hash);
                window.location.hash = hash;
            });
        });

        // HTML for methodologies is now hardcoded directly in the section
        // This function might be removed if no longer populating dynamically.
        // function populateMethodologies() { /* ... */ }

        function populateResources() {
            const container = document.getElementById('resources-container');
             const colors = {
                indigo: 'border-indigo-500 bg-indigo-50 text-indigo-900',
                rose: 'border-rose-500 bg-rose-50 text-rose-900',
                emerald: 'border-emerald-500 bg-emerald-50 text-emerald-900',
                violet: 'border-violet-500 bg-violet-50 text-violet-900',
            };
            let html = '';
            studyData.resources.forEach(res => {
                html += `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 ${colors[res.color]}">
                    <span class="text-4xl">${res.icon}</span>
                    <h3 class="text-xl font-bold mt-4">${res.title}</h3>
                    <p class="text-stone-600 mt-2 text-sm">${res.description}</p>
                    <div class="mt-3 flex flex-wrap gap-2">
                        ${res.items.map(item => `<span class="bg-stone-200 text-stone-700 text-xs font-semibold px-2 py-1 rounded-full">${item}</span>`).join('')}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function displayTopicDetails(subjectKey, topicIndex) {
            const subject = studyData.subjects[subjectKey];
            const allTopics = subject.topics;
            let topicDetailsHtml = '';

            allTopics.forEach((t, index) => {
                const isOpen = index === topicIndex;
                topicDetailsHtml += `
                    <div class="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
                        <button class="w-full text-left p-4 flex justify-between items-center font-semibold text-lg text-teal-800" onclick="toggleAccordion(this, '${subjectKey}', ${index})">
                            <span>${t.title}</span>
                            <span class="transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}">‚ñº</span>
                        </button>
                        <div class="accordion-content px-4 pb-4" style="${isOpen ? 'max-height: 9999px;' : ''}"> <!-- Changed max-height to a very large value -->
                            <p class="text-stone-600 mb-3">${t.detail}</p>
                            <div class="bg-teal-50 border-l-4 border-teal-400 p-3 rounded mb-4">
                                <h4 class="font-semibold text-teal-900">Aplica√ß√£o Pr√°tica na PF:</h4>
                                <p class="text-sm text-teal-800 mt-1">${t.application}</p>
                            </div>
                            ${t.subtopics && t.subtopics.length > 0 ? `
                                <h4 class="font-semibold text-teal-800 mb-2">Subt√≥picos:</h4>
                                <ul class="list-none space-y-2">
                                    ${t.subtopics.map((sub, subIndex) => `
                                        <li class="subtopic-item">
                                            <input type="checkbox" id="subtopic-${subjectKey}-${index}-${subIndex}" data-subject-key="${subjectKey}" data-topic-index="${index}" data-subtopic-index="${subIndex}" ${sub.completed ? 'checked' : ''} class="subtopic-checkbox h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                            <label for="subtopic-${subjectKey}-${index}-${subIndex}" class="text-stone-700">
                                                ${sub.name}
                                            </label>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            topicDetailsContainer.innerHTML = topicDetailsHtml;

            document.querySelectorAll('.subtopic-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleSubtopicCheck);
                const label = checkbox.nextElementSibling;
                if (checkbox.checked) {
                    label.classList.add('line-through', 'text-gray-500');
                } else {
                    label.classList.remove('line-through', 'text-gray-500');
                }
            });
        }
        
        window.toggleAccordion = (button, subjectKey, topicIndex) => {
            const content = button.nextElementSibling;
            const allContents = document.querySelectorAll('#topic-details .accordion-content');
            const allButtons = document.querySelectorAll('#topic-details button');

            allContents.forEach((c, i) => {
                const btn = allButtons[i];
                if (c !== content && c.style.maxHeight !== '0px') {
                    c.style.maxHeight = '0px';
                    btn.querySelector('span:last-child').classList.remove('rotate-180');
                }
            });

            if (content.style.maxHeight === '0px' || !content.style.maxHeight) {
                // Set max-height to scrollHeight plus a buffer for padding/margin
                content.style.maxHeight = content.scrollHeight + 30 + 'px'; // Add a small buffer
                 button.querySelector('span:last-child').classList.add('rotate-180');
            } else {
                content.style.maxHeight = '0px';
                button.querySelector('span:last-child').classList.remove('rotate-180');
            }
        };

        function handleSubtopicCheck(event) {
            const checkbox = event.target;
            const subjectKey = checkbox.dataset.subjectKey;
            const topicIndex = parseInt(checkbox.dataset.topicIndex);
            const subtopicIndex = parseInt(checkbox.dataset.subtopicIndex);

            if (studyData.subjects[subjectKey] &&
                studyData.subjects[subjectKey].topics[topicIndex] &&
                studyData.subjects[subjectKey].topics[topicIndex].subtopics[subtopicIndex]) {
                
                studyData.subjects[subjectKey].topics[topicIndex].subtopics[subtopicIndex].completed = checkbox.checked;
                const label = checkbox.nextElementSibling;
                if (checkbox.checked) {
                    label.classList.add('line-through', 'text-gray-500');
                } else {
                    label.classList.remove('line-through', 'text-gray-500');
                }
                saveProgress();
                updateProgressBar();
            }
        }

        function renderChart(subjectKey) {
            const subject = studyData.subjects[subjectKey];
            const ctx = document.getElementById('topicsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }

            document.getElementById('chart-title').innerText = `T√≥picos Mais Cobrados: ${subject.name}`;

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subject.chartData.labels,
                    datasets: [{
                        label: '% de Incid√™ncia (CEBRASPE)',
                        data: subject.chartData.data,
                        backgroundColor: 'rgba(13, 148, 136, 0.7)',
                        borderColor: 'rgba(15, 118, 110, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%'
                                }
                            }
                        },
                        y: {
                           ticks: {
                                autoSkip: false
                           }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.dataset.label}: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const chartElement = elements[0];
                            const index = chartElement.index;
                            displayTopicDetails(subjectKey, index);
                        }
                    }
                }
            });
            displayTopicDetails(subjectKey, 0); 
        }

        Object.keys(studyData.subjects).forEach(key => {
            const subject = studyData.subjects[key];
            const button = document.createElement('button');
            button.className = 'subject-button px-4 py-2 text-sm font-semibold text-teal-700 bg-white border-2 border-teal-600 rounded-full hover:bg-teal-50 transition-colors';
            button.innerHTML = `${subject.icon} ${subject.name}`;
            button.dataset.subject = key;
            subjectButtonsContainer.appendChild(button);

            button.addEventListener('click', () => {
                document.querySelectorAll('.subject-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                renderChart(key);
            });
        });
        
        // Initial setup for the first subject button if auth is ready before DOMContentLoaded is finished.
        // This might run before loadProgress completes, so data will be default until loadProgress resolves.
        if (isAuthReady) {
            const firstSubjectKey = Object.keys(studyData.subjects)[0];
            if (document.querySelector(`.subject-button[data-subject="${firstSubjectKey}"]`)) {
                document.querySelector(`.subject-button[data-subject="${firstSubjectKey}"]`).click();
            }
        }
    });
</script>
</body>
</html>
